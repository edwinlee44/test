select
M_ADJUSTEDR	as AdjustedRate,
M_BALANCE		as Balance,
M_CALCEND		as CalcEnd,
M_CALCSTART	as CalcStart,
M_COLAGREEM	as ColAgreement,
M_CUMINTERE	as CumInterest,
M_CURRENCY	as Currency,
M_NBDAYS		as Days,
M_FIXING		as Fixing,
M_INTEREST	as Interest,
M_PAYMENTAM	as PaymentAmt,
M_PAYMENTDA	as PaymentDate,
M_PERIODEND	as PeriodEnd,
M_PERIODSTA	as PeriodStart,
M_SPREAD		as Spread,
M_INVTYPE		as Type,
M_MXCTPENTIT,
AGR.M_AGREEMENTC as Country,
AGR.M_WITHHOLDIN as Witholding,
AGR.M_ONSHORE_OF as On_OffShore,
AGR.M_TAXRATE as Taxrate,
CASE
     WHEN AGR.M_ONSHORE_OF = 'Offshore' AND INTR.M_PAYMENTAM < 0
     THEN 
        ROUND(INTR.M_PAYMENTAM/(1-AGR.M_TAXRATE)*AGR.M_TAXRATE,2)
     WHEN (AGR.M_ONSHORE_OF = 'Onshore' AND AGR.M_WITHHOLDIN = 'Y' AND INTR.M_PAYMENTAM >0 ) 
     OR   (AGR.M_ONSHORE_OF = 'Onshore' AND abs(INTR.M_PAYMENTAM*AGR.M_TAXRATE*ROUND(FX2.M_RATE,6)) > 2000 AND INTR.M_PAYMENTAM <0 )
     THEN
        ROUND((-1)*INTR.M_CUMINTERE* AGR.M_TAXRATE,2)
      ELSE
        0
      END AS TAX_CHECK,
CASE
      WHEN AGR.M_ONSHORE_OF = 'Offshore' AND INTR.M_PAYMENTAM < 0
      THEN 
        ROUND(INTR.M_PAYMENTAM+(INTR.M_PAYMENTAM/(1-AGR.M_TAXRATE)*AGR.M_TAXRATE),2)
      WHEN (AGR.M_ONSHORE_OF = 'Onshore' AND AGR.M_WITHHOLDIN = 'Y' AND INTR.M_PAYMENTAM >0 ) 
      OR   (AGR.M_ONSHORE_OF = 'Onshore' AND abs(INTR.M_PAYMENTAM*AGR.M_TAXRATE*ROUND(FX2.M_RATE,6)) > 2000 AND INTR.M_PAYMENTAM <0 )
      THEN
         ROUND((-1)*INTR.M_CUMINTERE-((-1)*INTR.M_CUMINTERE* AGR.M_TAXRATE),2)
       ELSE
         ROUND(INTR.M_PAYMENTAM,2)
       END AS TAXTOTAL_CHECK,
ROUND(M_PAYMENTAM/(1-AGR.M_TAXRATE)*AGR.M_TAXRATE,2) as Tax,
M_PAYMENTAM +(ROUND(M_PAYMENTAM/(1-AGR.M_TAXRATE)*AGR.M_TAXRATE,2)) as TaxTotal,
ROUND(FX.M_SC2_CUR_AC,6) as Fxrate,
trunc(ROUND(FX.M_SC2_CUR_AC,6)*(M_PAYMENTAM + (ROUND(M_PAYMENTAM/(1-AGR.M_TAXRATE)*AGR.M_TAXRATE,2)))) as Payment_TWD,
trunc(ROUND(FX.M_SC2_CUR_AC,6)*(ROUND(M_PAYMENTAM/(1-AGR.M_TAXRATE)*AGR.M_TAXRATE,2))) as Tax_TWD
from 
COL_INTERESTS_FB_REP INTR,
COL_AGREEMENT_FB_REP AGR,
MXDM_FX_CURR_H_REP FX,
MLC_FX_REP FX2
where trim(M_COLAGREEM) = trim(AGR.M_NAME)
and trim(M_CURRENCY )= trim(FX.M_LABEL(+))
and M_PAYMENTDA = FX.M_CRT_BND12(+)
and trim(M_CURRENCY ) = trim(FX2.M_NUM(+))
and INTR.M_REF_DATA=@MxDataSetKey:N